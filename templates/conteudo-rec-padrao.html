{% extends "conteudo-base.html" %}

{% block title %}Módulo 3: Reconhecimento de Padrões{% endblock %}

{% block content_title %}Módulo 3: A Lei da Semelhança (Reconhecimento de Padrões){% endblock %}

{% block content %}
    <div class="content-section">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-video mr-3"></i> Vídeo Aula: Identificando Semelhanças
        </h2>
        <div class="video-container">
            <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <p class="text-gray-500 mt-4">Encontrar padrões em dados e eventos é o primeiro passo para criar soluções genéricas e eficientes.</p>
    </div>

    <div class="content-section">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-file-alt mr-3"></i> Material de Apoio (PDF)
        </h2>
        <p class="text-gray-700 mb-4">Guia sobre a aplicação de padrões comportamentais e de desempenho em sala de aula.</p>
        <a href="#" class="bg-secondary-green hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg inline-flex items-center transition duration-200">
            <i class="fas fa-download mr-2"></i> Baixar Padrões Pedagógicos
        </a>
    </div>

    <div class="content-section">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-clipboard-check mr-3"></i> Exercícios de Fixação
        </h2>
        <div class="space-y-6">

            <div id="q-mod3-1" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Módulo 3: Reconhecimento de Padrões</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">1. O reconhecimento de padrões é essencial porque:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-1', this, 'true', 'Perfeito! Reconhecer padrões torna o raciocínio mais ágil e adaptável.')" data-correct="true">
                        A) Permite criar soluções genéricas baseadas em experiências anteriores.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-1', this, 'false', 'O objetivo não é repetir, mas generalizar e aplicar.')" data-correct="false">
                        B) Depende da memorização de casos idênticos.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-1', this, 'false', 'O objetivo não é repetir, mas generalizar e aplicar.')" data-correct="false">
                        C) Ignora variações entre situações.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-1', this, 'false', 'O objetivo não é repetir, mas generalizar e aplicar.')" data-correct="false">
                        D) Restringe a criatividade do aluno.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-1', this, 'false', 'O objetivo não é repetir, mas generalizar e aplicar.')" data-correct="false">
                        E) Foca apenas na repetição de procedimentos.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>

            <div id="q-mod3-2" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Módulo 3: Reconhecimento de Padrões</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">2. A habilidade de reconhecer padrões se relaciona diretamente com:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-2', this, 'true', 'Correto! Padrões ajudam a formular algoritmos mais otimizados.')" data-correct="true">
                        A) A criação de algoritmos mais eficientes.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-2', this, 'false', 'Ignorar padrões leva à repetição desnecessária de trabalho.')" data-correct="false">
                        B) A memorização de conceitos complexos.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-2', this, 'false', 'Ignorar padrões leva à repetição desnecessária de trabalho.')" data-correct="false">
                        C) A eliminação de exceções e erros.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-2', this, 'false', 'Ignorar padrões leva à repetição desnecessária de trabalho.')" data-correct="false">
                        D) O isolamento de problemas específicos.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-2', this, 'false', 'Ignorar padrões leva à repetição desnecessária de trabalho.')" data-correct="false">
                        E) A simplificação sem reflexão.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>

            <div id="q-mod3-3" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Módulo 3: Reconhecimento de Padrões</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">3. A ausência de reconhecimento de padrões leva a:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-3', this, 'true', 'Exato! Sem padrões, cada problema é resolvido do zero.')" data-correct="true">
                        A) Soluções redundantes e lentas.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-3', this, 'false', 'O reconhecimento de padrões otimiza o tempo e o raciocínio.')" data-correct="false">
                        B) Maior eficiência e clareza.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-3', this, 'false', 'O reconhecimento de padrões otimiza o tempo e o raciocínio.')" data-correct="false">
                        C) Processos generalizáveis.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-3', this, 'false', 'O reconhecimento de padrões otimiza o tempo e o raciocínio.')" data-correct="false">
                        D) Interpretação mais precisa.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-3', this, 'false', 'O reconhecimento de padrões otimiza o tempo e o raciocínio.')" data-correct="false">
                        E) Colaboração produtiva.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>

            <div id="q-mod3-4" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Módulo 3: Reconhecimento de Padrões</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">4. Em contextos pedagógicos, reconhecer padrões ajuda a:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-4', this, 'true', 'Excelente! Padrões orientam intervenções pedagógicas mais eficazes.')" data-correct="true">
                        A) Criar estratégias personalizadas de ensino com base em comportamentos recorrentes.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-4', this, 'false', 'Reconhecer padrões não padroniza o ensino; ele o torna mais adaptativo.')" data-correct="false">
                        B) Aplicar uma metodologia fixa a todos os alunos.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-4', this, 'false', 'Reconhecer padrões não padroniza o ensino; ele o torna mais adaptativo.')" data-correct="false">
                        C) Ignorar o desempenho anterior dos estudantes.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-4', this, 'false', 'Reconhecer padrões não padroniza o ensino; ele o torna mais adaptativo.')" data-correct="false">
                        D) Substituir a avaliação formativa.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-4', this, 'false', 'Reconhecer padrões não padroniza o ensino; ele o torna mais adaptativo.')" data-correct="false">
                        E) Tornar o ensino rígido.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>

            <div id="q-mod3-5" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Módulo 3: Reconhecimento de Padrões</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">5. O reconhecimento de padrões está intimamente ligado à:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-5', this, 'true', 'Perfeito! Essa é a base para abstração e algoritmos.')" data-correct="true">
                        A) Construção de modelos generalizáveis.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-5', this, 'false', 'Reconhecer padrões é um passo para criar representações e modelos.')" data-correct="false">
                        B) Exclusão de variáveis.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-5', this, 'false', 'Reconhecer padrões é um passo para criar representações e modelos.')" data-correct="false">
                        C) Redução da complexidade sem análise.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-5', this, 'false', 'Reconhecer padrões é um passo para criar representações e modelos.')" data-correct="false">
                        D) Repetição literal de soluções.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod3-5', this, 'false', 'Reconhecer padrões é um passo para criar representações e modelos.')" data-correct="false">
                        E) Observação descontextualizada.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>

        </div>
    </div>

    <div class="content-section border-4 border-indigo-200 bg-indigo-50">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-lightbulb mr-3"></i> Questão de Projeto - Fase 3: Reconhecimento de Padrões
        </h2>
        <p class="text-gray-700 mb-4">Com base na Decomposição feita no Módulo 2, procure por padrões, similaridades e repetições entre as subetapas.</p>

        <div class="p-3 mb-4 bg-white rounded-lg border border-indigo-300">
            <h3 class="font-bold text-indigo-700 mb-2">Seu Projeto (Contexto):</h3>
            <p class="text-sm mb-1"><strong>Objetivo Geral (M1):</strong> <span id="display_objetivo_geral" class="font-normal text-gray-600 italic">Carregando...</span></p>
            <p class="text-sm"><strong>Decomposição (M2):</strong> <span id="display_decomposicao" class="font-normal text-gray-600 italic">Carregando...</span></p>
        </div>

        <form id="project-form-3">
            <div class="mb-4">
                <label for="reconhecimento_padroes" class="block text-gray-800 font-medium mb-2">Reconhecimento de Padrões: Identifique uma ação ou comportamento que se repete em diferentes subetapas e explique como você pode padronizá-lo/generalizá-lo para otimizar o projeto.</label>
                <textarea id="reconhecimento_padroes" name="reconhecimento_padroes" rows="5" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-primary-indigo focus:border-primary-indigo" placeholder="Exemplo: O padrão 'coleta de dados de alunos' se repete nas etapas 1 e 3. Posso padronizá-lo criando um formulário digital único."></textarea>
            </div>

            <div id="project-feedback" class="mt-4 text-sm font-medium text-gray-600 hidden"></div>
            <button type="submit" class="mt-4 bg-primary-indigo hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">Salvar Fase 3 do Projeto</button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração e Inicialização do Firebase (Assegure que as variáveis globais sejam injetadas pelo backend Flask)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        let db, auth, userId;
        const PROJECT_COLLECTION = 'project_data';
        const DOCUMENT_ID = 'main_project'; // Documento único para o projeto final

        setLogLevel('Debug');

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            async function authenticate() {
                try {
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser?.uid || crypto.randomUUID();
                    console.log("Firebase autenticado com userId:", userId);
                    loadProjectData();
                } catch (error) {
                    console.error("Erro na autenticação Firebase:", error);
                }
            }
            
            authenticate();
        } else {
            console.error("Configuração do Firebase não encontrada.");
        }

        // --------------------------------------------------
        // Lógica de Salvamento e Carregamento do Projeto
        // --------------------------------------------------

        function getProjectDocRef(dbInstance, uid) {
            // Caminho: artifacts / [appId] / users / [userId] / project_data / main_project
            return doc(dbInstance, 'artifacts', appId, 'users', uid, PROJECT_COLLECTION, DOCUMENT_ID);
        }

        async function saveProjectData(data) {
            if (!db || !userId) {
                console.error("Firebase ou userId não estão prontos.");
                return;
            }
            const feedbackEl = document.getElementById('project-feedback');
            try {
                const docRef = getProjectDocRef(db, userId);
                // Usamos merge: true para que cada módulo só atualize seus próprios campos
                await setDoc(docRef, data, { merge: true }); 
                feedbackEl.textContent = "✅ Projeto da Fase 3 (Reconhecimento de Padrões) salvo com sucesso!";
                feedbackEl.classList.remove('hidden', 'text-red-500');
                feedbackEl.classList.add('text-green-500');
            } catch (error) {
                console.error("Erro ao salvar dados do projeto:", error);
                feedbackEl.textContent = "❌ Erro ao salvar o projeto. Tente novamente.";
                feedbackEl.classList.remove('hidden', 'text-green-500');
                feedbackEl.classList.add('text-red-500');
            }
        }

        async function loadProjectData() {
            if (!db || !userId) {
                setTimeout(loadProjectData, 500); // Tenta novamente
                return;
            }

            try {
                const docRef = getProjectDocRef(db, userId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();

                    // 1. Carrega o campo do Módulo 3 (Reconhecimento de Padrões) para edição
                    document.getElementById('reconhecimento_padroes').value = data.reconhecimento_padroes || '';
                    
                    // 2. Carrega campos dos Módulos Anteriores para visualização (contexto)
                    document.getElementById('display_objetivo_geral').textContent = data.objetivo_geral || 'N/A (Preencha no Módulo 1)';
                    document.getElementById('display_decomposicao').textContent = data.decomposicao ? data.decomposicao.substring(0, 100) + (data.decomposicao.length > 100 ? '...' : '') : 'N/A (Preencha no Módulo 2)';


                    console.log("Dados do projeto carregados:", data);
                }
            } catch (error) {
                console.error("Erro ao carregar dados do projeto:", error);
            }
        }

        document.getElementById('project-form-3').addEventListener('submit', function(e) {
            e.preventDefault();
            const data = {
                // Salva o campo específico deste módulo
                reconhecimento_padroes: document.getElementById('reconhecimento_padroes').value,
                timestamp_m3: new Date().toISOString() // Adiciona um timestamp de salvamento
            };
            saveProjectData(data);
        });

        // --------------------------------------------------
        // Lógica de Verificação do Quiz (Mantida de módulos anteriores)
        // --------------------------------------------------
        window.checkAnswer = function(questionId, selectedOption, isCorrect, feedbackMessage) {
            const questionDiv = document.getElementById(questionId);
            const feedbackEl = questionDiv.querySelector('.feedback-message');
            const options = questionDiv.querySelectorAll('.quiz-option');

            // Converte o parâmetro 'isCorrect' para booleano
            const correct = isCorrect === 'true';

            // Desabilita todas as opções
            options.forEach(opt => {
                opt.classList.add('disabled');
                opt.onclick = null; // Remove o evento de clique
            });

            // Aplica estilos e exibe feedback
            if (correct) {
                selectedOption.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                selectedOption.classList.add('correct', 'border-green-500', 'bg-green-100');
                feedbackEl.textContent = feedbackMessage;
                feedbackEl.classList.remove('hidden', 'text-red-500', 'bg-red-100');
                feedbackEl.classList.add('text-green-700', 'bg-green-100', 'p-2', 'rounded');
            } else {
                selectedOption.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                selectedOption.classList.add('incorrect', 'border-red-500', 'bg-red-100');
                
                // Encontra e destaca a resposta correta
                options.forEach(opt => {
                    if (opt.getAttribute('data-correct') === 'true') {
                        opt.classList.remove('bg-gray-100');
                        opt.classList.add('correct', 'border-green-500', 'bg-green-200');
                    }
                });
                
                feedbackEl.textContent = feedbackMessage;
                feedbackEl.classList.remove('hidden', 'text-green-500', 'bg-green-100');
                feedbackEl.classList.add('text-red-700', 'bg-red-100', 'p-2', 'rounded');
            }
        };
    </script>
{% endblock %}

{% block finish_button %}
    <div class="mt-8 text-center">
        <form method="POST" action="{{ url_for('concluir_modulo', modulo_nome='rec_padrao') }}">
            <button type="submit" class="btn-finish hover:shadow-lg">
                <i class="fas fa-check-double mr-2"></i>Próximo Módulo
            </button>
        </form>
    </div>
{% endblock %}
