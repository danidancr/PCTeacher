{% extends "conteudo-base.html" %}

{% block title %}Módulo 3: Reconhecimento de Padrões{% endblock %}

{% block content_title %}Módulo 3: Reconhecimento de Padrões{% endblock %}

{% block content %}
    <div class="content-section">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-video mr-3"></i> Vídeo Aula: Identificando Semelhanças
        </h2>
        <div class="video-container">
            <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <p class="text-gray-500 mt-4">Encontrar padrões em dados e eventos é o primeiro passo para criar soluções genéricas e eficientes.</p>
    </div>

    <div class="content-section">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-clipboard-check mr-3"></i> Exercícios de Fixação
        </h2>
        <div class="space-y-6">
            
            <div id="q-mod2-1" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Conceitual</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">1. Por que a identificação de padrões é crucial após a decomposição de um problema?</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-1', this, 'false', '❌ Incorreto. A decomposição já quebrou o problema; o padrão serve para encontrar similaridades, não para re-dividir.')" data-correct="false">
                        A) Para re-dividir o problema em etapas ainda menores.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-1', this, 'true', '✅ Correto! Padrões permitem a criação de uma solução única e genérica (abstração) que pode ser aplicada a todas as subtarefas semelhantes.')" data-correct="true">
                        B) Para criar soluções genéricas que podem ser aplicadas a várias subtarefas semelhantes.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-1', this, 'false', '❌ Incorreto. A identificação de padrões pode simplificar, mas o objetivo primário é a otimização da solução.')" data-correct="false">
                        C) Para garantir que o problema não tenha detalhes irrelevantes.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-1', this, 'false', '❌ Incorreto. Algoritmos é o próximo passo. O padrão é a ponte entre a decomposição e a abstração/algoritmo.')" data-correct="false">
                        D) Para gerar o algoritmo final sem precisar de mais etapas.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>
            
            <div id="q-mod2-2" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Aplicação Pedagógica</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">2. Em um conjunto de provas de matemática, 80% dos alunos cometeram erros na mesma fórmula. Qual ação demonstra o reconhecimento e uso de um padrão?</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-2', this, 'false', '❌ Incorreto. Isso é Decomposição, não reconhecimento de padrões. O padrão já está estabelecido (erro na fórmula).')" data-correct="false">
                        A) Criar 10 provas diferentes para evitar que os alunos copiem as respostas.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-2', this, 'false', '❌ Incorreto. Essa é uma resposta individualizada, não uma otimização sistêmica baseada no padrão do erro.')" data-correct="false">
                        B) Devolver as provas e pedir que cada aluno revise seus próprios erros.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-2', this, 'false', '❌ Incorreto. A abstração viria após identificar o erro recorrente, focando no princípio por trás da fórmula, mas a ação ainda não demonstra o uso do padrão.')" data-correct="false">
                        C) Explicar aos alunos o conceito fundamental por trás da fórmula, ignorando a parte prática.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-2', this, 'true', '✅ Correto! Ao notar que o erro é comum, o professor aplica uma solução centralizada (revisão da fórmula) que aborda o ponto fraco de forma eficiente.')" data-correct="true">
                        D) Interromper a próxima aula para fazer uma revisão coletiva focada apenas na aplicação correta daquela fórmula.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>
            
            <div id="q-mod2-3" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Desenvolvimento de Habilidade</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">3. A repetição intencional de um mesmo tipo de exercício (com dados diferentes) para que o aluno internalize uma regra ou método é uma aplicação didática direta de qual pilar do Pensamento Computacional?</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-3', this, 'false', '❌ Incorreto. Abstração é a simplificação; a repetição é a prática de encontrar e aplicar a regra.')" data-correct="false">
                        A) Abstração.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-3', this, 'true', '✅ Exato! O aluno pratica o reconhecimento de que, apesar dos números diferentes, o método (o padrão) para a solução é sempre o mesmo.')" data-correct="true">
                        B) Reconhecimento de Padrões.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-3', this, 'false', '❌ Incorreto. Decomposição é a quebra do problema; aqui, a ênfase é na solução recorrente.')" data-correct="false">
                        C) Decomposição.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-3', this, 'false', '❌ Incorreto. Algoritmos é a sequência de passos; o Reconhecimento de Padrões é que define qual sequência usar.')" data-correct="false">
                        D) Algoritmos.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>
            
            <div id="q-mod2-4" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Relação entre Pilares</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">4. Qual é o pilar do Pensamento Computacional que, obrigatoriamente, precede o reconhecimento de padrões?</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-4', this, 'false', '❌ Incorreto. A Abstração vem após o reconhecimento do padrão (para simplificar o método), mas a Decomposição vem antes.')" data-correct="false">
                        A) Abstração.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-4', this, 'false', '❌ Incorreto. Algoritmos é o resultado final. O padrão é que permite a criação de um algoritmo.')" data-correct="false">
                        B) Algoritmos.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-4', this, 'true', '✅ Correto! É preciso decompor o problema em partes para que se possa, então, comparar essas partes e identificar padrões (semelhanças).')" data-correct="true">
                        C) Decomposição.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-4', this, 'false', '❌ Incorreto. Depuração é um processo de correção que pode ocorrer em qualquer fase.')" data-correct="false">
                        D) Depuração (Debugging).
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>
            
            <div id="q-mod2-5" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Benefício Principal</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">5. O principal benefício do reconhecimento de padrões para o pensamento humano é:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-5', this, 'false', '❌ Incorreto. O foco é na eficiência e na generalização, não na memorização.')" data-correct="false">
                        A) Facilitar a memorização de fatos.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-5', this, 'false', '❌ Incorreto. Embora útil, a detecção de anomalias é uma função secundária do reconhecimento de padrões.')" data-correct="false">
                        B) Permitir a detecção de anomalias e erros.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-5', this, 'false', '❌ Incorreto. A decomposição é quem trata a complexidade; o padrão traz a eficiência.')" data-correct="false">
                        C) Tornar os problemas mais complexos.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod2-5', this, 'true', '✅ Perfeito! Ao reconhecer padrões, o cérebro não precisa resolver o problema do zero toda vez, o que economiza tempo e recursos cognitivos (generalização).')" data-correct="true">
                        D) Permitir a generalização de soluções, aumentando a eficiência.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>

        </div>
    </div>

    <div class="content-section border-4 border-indigo-200 bg-indigo-50 p-6 rounded-xl">
        <h2 class="text-2xl font-bold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-sitemap mr-3"></i> Questão de Projeto: Otimização da Metodologia por Padrões
        </h2>
        <p class="text-gray-700 mb-6">Relembre as subpartes do seu projeto (decomposição) e encontre similaridades. Use a identificação de padrões para otimizar a metodologia.</p>
        
        <form id="project-questions-form-mod3" onsubmit="saveProjectAnswersMod3(event)">
            
            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2 border-indigo-300">Identificação e Otimização de Padrões (Módulo 3)</h3>

            <div class="mb-6">
                <label for="p5_otimizacao_padrao" class="block text-gray-800 font-medium mb-2">1. Identifique uma **ação ou recurso** que se repete em diferentes fases do seu projeto. Como você pode criar um **mecanismo único** para reutilizar ou simplificar essa repetição?</label>
                <textarea id="p5_otimizacao_padrao" rows="6" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-primary-indigo focus:border-primary-indigo" placeholder="Ex: A avaliação formativa é um padrão que se repete em 3 módulos. Podemos otimizá-la criando um único 'Template de Feedback' em vez de criar três documentos diferentes." required></textarea>
            </div>
            
            <button type="submit" id="save-button-mod3" class="mt-4 bg-primary-indigo hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                <i class="fas fa-save mr-2"></i> Salvar Otimização de Padrão
            </button>

            <div id="save-feedback-mod3" class="mt-4 p-3 rounded-lg text-sm hidden" role="alert"></div>

        </form>
    </div>
{% endblock %}

{% block finish_button %}
    <div class="mt-8 text-center">
        <form method="POST" action="{{ url_for('concluir_modulo', modulo_nome='rec_padrao') }}">
            <button type="submit" class="btn-finish hover:shadow-lg">
                <i class="fas fa-check-double mr-2"></i>Próximo Módulo
            </button>
        </form>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        // Assumindo que o Firebase SDK e sua inicialização já estão carregados (db)
        // const db = firebase.firestore(); 
        
        // **IMPORTANTE**: Garanta que o UID do usuário seja a mesma variável usada nos módulos anteriores.
        const CURRENT_USER_ID = '{{ g.user.uid if g.user else "teste-user-id" }}'; 
        const PROJECT_DOC_ID = 'user_project_' + CURRENT_USER_ID; 
        const formMod3 = document.getElementById('project-questions-form-mod3');

        // ----------------------------------------------------
        // Lógica de Salvamento Módulo 3 (Firebase/Firestore)
        // ----------------------------------------------------
        async function saveProjectAnswersMod3(event) {
            event.preventDefault(); 
            
            const feedbackDiv = document.getElementById('save-feedback-mod3');
            const saveButton = document.getElementById('save-button-mod3');

            // 1. Coletar o dado do formulário
            const respostaOtimizacao = document.getElementById('p5_otimizacao_padrao').value.trim();
            
            // 2. Criar o Array de Respostas
            const newAnswers = [
                {
                    id: "mod3_p5_otimizacao_padrao",
                    ordem: 5, // Continua a contagem de ordem (Pergunta 5 do Projeto)
                    secao: "Otimização de Padrões (Módulo 3)",
                    pergunta: formMod3.querySelector('label[for="p5_otimizacao_padrao"]').textContent,
                    resposta: respostaOtimizacao
                }
            ];

            // 3. Validação
            if (!respostaOtimizacao) {
                feedbackDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700 block';
                feedbackDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Por favor, preencha o campo de otimização de padrão antes de salvar.';
                return;
            }

            try {
                // Desabilitar o botão e mostrar feedback
                saveButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Salvando...';

                // **Chave:** Salvar no campo 'perguntasM3' usando merge: true
                await db.collection("projetos").doc(PROJECT_DOC_ID).set({
                    perguntasM3: newAnswers, // Novo campo para o Módulo 3
                    ultimaAtualizacaoM3: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                // Feedback de sucesso
                feedbackDiv.className = 'mt-4 p-3 rounded-lg bg-green-100 text-green-700 block';
                feedbackDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Otimização de Padrão salva com sucesso!';
            } catch (error) {
                console.error("Erro ao salvar no Firebase: ", error);
                feedbackDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700 block';
                feedbackDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> Erro ao salvar. Tente novamente. (${error.message})`;
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save mr-2"></i> Salvar Otimização de Padrão';
            }
        }

        // ----------------------------------------------------
        // Lógica de Carregamento (Pré-preenchimento)
        // ----------------------------------------------------
        async function loadProjectAnswersMod3() {
            try {
                const doc = await db.collection("projetos").doc(PROJECT_DOC_ID).get();
                if (doc.exists) {
                    const data = doc.data();
                    const answersM3 = data.perguntasM3 || [];
                    
                    const otimizacaoData = answersM3.find(item => item.id === 'mod3_p5_otimizacao_padrao');
                    const inputElement = document.getElementById('p5_otimizacao_padrao');

                    if (otimizacaoData && inputElement) {
                        inputElement.value = otimizacaoData.resposta;
                    }
                }
            } catch (error) {
                console.error("Erro ao carregar dados do projeto:", error);
            }
        }
        
        // Chamada para carregar os dados ao carregar a página
        // loadProjectAnswersMod3(); // Descomente quando o Firebase SDK estiver configurado
    </script>
{% endblock %}
