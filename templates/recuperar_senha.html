<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Definir Nova Senha - PC Teacher</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ... Seu CSS permanece o mesmo ... */
        :root {
            --color-primary-dark: #1F192F;
            --color-blue: #2D6073 ;
            --color-text-light: #ffffff;
            --color-success: #155724;
            --color-error: #721c24;
            --font-family: 'Poppins', sans-serif;
        }
        /* ... (Resto do seu CSS) ... */
        /* Novo estilo para o campo de e-mail desabilitado */
        .input-group input:disabled {
            background-color: #f4f4f4;
            color: #777;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
</head>
<body>

    <div class="reset-box">

        <div id="message-area">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert {{ category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <h2>Redefinir Senha</h2>
        <p class="subtitle">Insira a nova senha para o seu e-mail.</p>

        <form id="password-reset-form"> 

            <div class="input-group">
                <label for="email">E-mail de Redefini√ß√£o</label>
                <input type="email" id="email" name="email" value="" disabled> 
            </div>

            <div class="grid-2-cols">
                <div class="input-group">
                    <label for="new-password">Nova Senha</label>
                    <input type="password" id="new-password" name="new_password" placeholder="M√≠nimo 6 caracteres" minlength="6" required>
                </div>
                <div class="input-group">
                    <label for="confirm-password">Confirmar Senha</label>
                    <input type="password" id="confirm-password" name="confirm_password" placeholder="Repita a nova senha" minlength="6" required>
                </div>
            </div>

            <div class="buttons-group">
                <button type="submit" class="btn-submit" id="main-button">REDEFINIR SENHA</button>
                <div id="loading-spinner" style="display:none; margin-top: 15px;">
                    <i class="fas fa-spinner fa-spin"></i> Redefinindo...
                </div>
            </div>
        </form>

        <a href="{{ url_for('login') }}" class="back-link">
            <i class="fas fa-arrow-left"></i> Voltar √† tela de Login
        </a>
    </div>

    <script>
        // Use a fun√ß√£o para mostrar mensagens no template sem o Flask flash
        function displayMessage(message, category) {
            const area = document.getElementById('message-area');
            area.innerHTML = `<div class="alert ${category}">${message}</div>`;
        }

        // =========================================================
        // üö® Configura√ß√£o do Firebase Client SDK (MUITO IMPORTANTE!)
        // =========================================================
        // Voc√™ precisa das chaves de configura√ß√£o do seu projeto Firebase (apiKey, authDomain, etc.)
        // Estas chaves N√ÉO s√£o as chaves do Admin SDK, s√£o as chaves p√∫blicas do seu app web.
        // √â seguro coloc√°-las aqui ou carreg√°-las de uma vari√°vel de ambiente p√∫blica.
        const firebaseConfig = {
            apiKey: "{{ FIREBASE_API_KEY }}", // Voc√™ precisa passar esta vari√°vel no Flask context
            authDomain: "{{ FIREBASE_AUTH_DOMAIN }}", // Voc√™ precisa passar esta vari√°vel no Flask context
            // ... outras chaves se necess√°rio
        };

        // Inicializa o Firebase Client SDK
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const authClient = firebase.auth();
        const form = document.getElementById('password-reset-form');
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const emailInput = document.getElementById('email');
        const submitButton = document.getElementById('main-button');
        const loadingSpinner = document.getElementById('loading-spinner');

        // 1. LER OS PAR√ÇMETROS DA URL
        const urlParams = new URLSearchParams(window.location.search);
        const actionCode = urlParams.get('oobCode'); // Este √© o token do Firebase
        const emailFromUrl = urlParams.get('email'); // O e-mail pode estar na URL

        if (!actionCode) {
            displayMessage("Link de redefini√ß√£o inv√°lido ou expirado. Tente novamente.", 'danger');
            submitButton.disabled = true;
        } else {
            // Se o token existe, verifica o e-mail associado
            emailInput.value = emailFromUrl || 'Buscando...';
            
            authClient.verifyPasswordResetCode(actionCode).then((email) => {
                emailInput.value = email; // Define o e-mail no campo
                submitButton.disabled = false;
                displayMessage("E-mail verificado. Defina sua nova senha.", 'success');
            }).catch((error) => {
                console.error("Erro ao verificar o c√≥digo:", error);
                displayMessage("O c√≥digo de redefini√ß√£o √© inv√°lido ou expirou. Tente o processo novamente.", 'danger');
                submitButton.disabled = true;
            });
        }


        // 2. L√≥gica de Submiss√£o do Formul√°rio
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (newPassword !== confirmPassword) {
                displayMessage("As novas senhas digitadas n√£o coincidem.", 'danger');
                return;
            }
            if (newPassword.length < 6) {
                displayMessage("A nova senha deve ter no m√≠nimo 6 caracteres.", 'danger');
                return;
            }

            submitButton.style.display = 'none';
            loadingSpinner.style.display = 'block';

            authClient.confirmPasswordReset(actionCode, newPassword).then(() => {
                displayMessage("‚úÖ Senha redefinida com sucesso! Voc√™ ser√° redirecionado em 3 segundos.", 'success');
                // Ap√≥s o sucesso, voc√™ pode querer chamar uma rota do Flask para limpar o cache ou registrar o evento
                setTimeout(() => {
                     // Redireciona para o login
                    window.location.href = "{{ url_for('login') }}"; 
                }, 3000);

            }).catch((error) => {
                console.error("Erro ao redefinir senha:", error);
                // Exibe erro (ex: senha muito fraca, token inv√°lido novamente)
                let errorMessage = "Erro ao redefinir senha. Verifique se o c√≥digo n√£o expirou e a senha √© v√°lida.";
                if (error.code === 'auth/weak-password') {
                    errorMessage = "A senha √© muito fraca. Escolha uma senha com pelo menos 6 caracteres.";
                }
                displayMessage(errorMessage, 'danger');
                submitButton.style.display = 'block';
                loadingSpinner.style.display = 'none';
            });
        });

    </script>
</body>
</html>
