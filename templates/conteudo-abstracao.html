{% extends "conteudo-base.html" %}

{% block title %}Módulo 4: Abstração{% endblock %}

{% block content_title %}Módulo 4: Abstração - Foco no Essencial{% endblock %}

{% block content %}
    <div class="content-section">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-video mr-3"></i> Vídeo Aula: Ignorando o Irrelevante
        </h2>
        <div class="video-container">
            <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <p class="text-gray-500 mt-4">Aprenda a criar modelos mentais e representações, focando apenas nas características cruciais.</p>
    </div>

    <div class="content-section">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-clipboard-check mr-3"></i> Exercícios de Fixação
        </h2>
        <div class="space-y-6">
            
            <div id="q-mod4-1" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Conceitual</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">1. Qual das ações a seguir é o exemplo mais claro de Abstração?</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-1', this, 'false', '❌ Incorreto. Isso é Decomposição, que é a quebra do problema.')" data-correct="false">
                        A) Dividir a avaliação em quatro sub-tópicos menores.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-1', this, 'false', '❌ Incorreto. Isso é Reconhecimento de Padrões, que foca nas similaridades.')" data-correct="false">
                        B) Usar o mesmo template de feedback para todas as turmas.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-1', this, 'true', '✅ Correto! Abstração envolve criar um modelo genérico (O ALUNO) que representa o essencial, ignorando detalhes irrelevantes (cor, idade, etc.).')" data-correct="true">
                        C) Criar um "Perfil Padrão do Aluno" com notas médias e objetivos de aprendizagem, ignorando sua cor, idade ou hobbies.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-1', this, 'false', '❌ Incorreto. Isso é Pensamento Algorítmico (criação de passos) ou Decomposição.')" data-correct="false">
                        D) Listar passo a passo como um aluno deve enviar uma tarefa no LMS (Sistema de Gestão de Aprendizagem).
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>
            
            <div id="q-mod4-2" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">IADES - Adaptada</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">2. Segundo os pilares do Pensamento Computacional (Decomposição, Padrões, Abstração e Algoritmos), a Abstração é a ferramenta mental que permite:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-2', this, 'false', '❌ Incorreto. Isso é Decomposição, que é a primeira etapa.')" data-correct="false">
                        A) A reformulação do problema original em sub-problemas menores e mais tratáveis.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-2', this, 'true', '✅ Correto! Abstração foca no essencial e ignora os detalhes, criando um modelo (a essência) da solução.')" data-correct="true">
                        B) Focar nas informações relevantes e desconsiderar detalhes irrelevantes ou específicos do contexto.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-2', this, 'false', '❌ Incorreto. Isso é Pensamento Algorítmico, que é o último passo.')" data-correct="false">
                        C) Criar uma sequência lógica e ordenada de passos para resolver o problema.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-2', this, 'false', '❌ Incorreto. Isso é Reconhecimento de Padrões, que é a identificação de similaridades.')" data-correct="false">
                        D) Utilizar soluções prévias para resolver novos problemas similares.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>
            
            <div id="q-mod4-3" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Modelo Mental</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">3. A criação de um mapa conceitual que representa as interconexões entre ideias-chave em uma disciplina, ignorando exemplos práticos específicos, é um ato de:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-3', this, 'false', '❌ Incorreto. O foco não é na sequência de passos (Algoritmo).')" data-correct="false">
                        A) Pensamento Algorítmico.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-3', this, 'true', '✅ Correto! Ao focar apenas nas interconexões e nos conceitos centrais (o essencial) e ignorar os exemplos (o irrelevante), você está abstraindo.')" data-correct="true">
                        B) Abstração.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-3', this, 'false', '❌ Incorreto. Embora haja decomposição na escolha dos conceitos, o ato de *ignorar os exemplos* e criar o mapa é a Abstração.')" data-correct="false">
                        C) Decomposição.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-3', this, 'false', '❌ Incorreto. O Reconhecimento de Padrões é a etapa que precede, identificando as similaridades.')" data-correct="false">
                        D) Reconhecimento de Padrões.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>
            
            <div id="q-mod4-4" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Relação entre Pilares</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">4. A Abstração no Pensamento Computacional atua como uma ponte direta entre qual dos pilares?</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-4', this, 'false', '❌ Incorreto. Decomposição é a primeira etapa, muito antes da Abstração.')" data-correct="false">
                        A) Decomposição e Reconhecimento de Padrões.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-4', this, 'true', '✅ Exato! O Reconhecimento de Padrões fornece as similaridades, a Abstração usa essas similaridades para criar um modelo único, que, por sua vez, será usado no Algoritmo.')" data-correct="true">
                        B) Reconhecimento de Padrões e Algoritmos.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-4', this, 'false', '❌ Incorreto. Abstração e Decomposição não têm essa conexão direta.')" data-correct="false">
                        C) Abstração e Decomposição.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-4', this, 'false', '❌ Incorreto. Decomposição e Algoritmos são os extremos, com os outros dois pilares entre eles.')" data-correct="false">
                        D) Decomposição e Algoritmos.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>
            
            <div id="q-mod4-5" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Utilidade da Abstração</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">5. A Abstração é essencial para a criação de:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-5', this, 'true', '✅ Correto! Funções e Módulos são a concretização da Abstração, permitindo que o mesmo código/estrutura seja reutilizado em diferentes contextos.')" data-correct="true">
                        A) Funções e Módulos reutilizáveis.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-5', this, 'false', '❌ Incorreto. Isso é o papel da Decomposição.')" data-correct="false">
                        B) Listas detalhadas de tarefas.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-5', this, 'false', '❌ Incorreto. A Abstração foca no essencial e ignora os detalhes, portanto, não serve para criar detalhamento.')" data-correct="false">
                        C) Detalhamentos técnicos completos.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod4-5', this, 'false', '❌ Incorreto. Embora a Abstração ajude, o foco principal é na generalização e reutilização.')" data-correct="false">
                        D) Exceções e regras específicas.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>

        </div>
    </div>

    <div class="content-section border-4 border-indigo-200 bg-indigo-50 p-6 rounded-xl">
        <h2 class="text-2xl font-bold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-lightbulb mr-3"></i> Questão de Projeto: O Modelo Essencial
        </h2>
        <p class="text-gray-700 mb-6">Esta é a etapa de abstração do seu projeto. Vamos criar um modelo que represente a essência do seu trabalho.</p>
        
        <form id="project-questions-form-mod4" onsubmit="saveProjectAnswersMod4(event)">
            
            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2 border-indigo-300">Modelo Essencial (Módulo 4)</h3>

            <div class="mb-6">
                <label for="p6_abstracao_projeto" class="block text-gray-800 font-medium mb-2">1. Considerando os padrões identificados no Módulo 3, crie uma **Abstração** para o seu projeto. Qual é o **modelo ou a regra essencial** que define a sua solução? Quais são os detalhes que podem ser **ignorados** neste momento para criar uma representação simples e poderosa?</label>
                <textarea id="p6_abstracao_projeto" rows="6" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-primary-indigo focus:border-primary-indigo" placeholder="Ex: O modelo essencial é: 'Se a tarefa A for concluída e o tempo X for excedido, acione o feedback B.' Ignoramos a cor do botão, o nome exato do aluno, e focamos apenas nas variáveis lógicas (Tarefa, Tempo, Feedback)." required></textarea>
            </div>
            
            <button type="submit" id="save-button-mod4" class="mt-4 bg-primary-indigo hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                <i class="fas fa-save mr-2"></i> Salvar Abstração
            </button>

            <div id="save-feedback-mod4" class="mt-4 p-3 rounded-lg text-sm hidden" role="alert"></div>

        </form>
    </div>
{% endblock %}

{% block finish_button %}
    <div class="mt-8 text-center">
        <form method="POST" action="{{ url_for('concluir_modulo', modulo_nome='abstracao') }}">
            <button type="submit" class="btn-finish hover:shadow-lg">
                <i class="fas fa-check-double mr-2"></i>Próximo Módulo
            </button>
        </form>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        // Assumindo que o Firebase SDK e sua inicialização já estão carregados (db)
        // const db = firebase.firestore(); 
        
        // **IMPORTANTE**: Garanta que o UID do usuário seja a mesma variável usada nos módulos anteriores.
        const CURRENT_USER_ID = '{{ g.user.uid if g.user else "teste-user-id" }}'; 
        const PROJECT_DOC_ID = 'user_project_' + CURRENT_USER_ID; 
        const formMod4 = document.getElementById('project-questions-form-mod4');

        // ----------------------------------------------------
        // Lógica de Salvamento Módulo 4 (Firebase/Firestore)
        // ----------------------------------------------------
        async function saveProjectAnswersMod4(event) {
            event.preventDefault(); 
            
            const feedbackDiv = document.getElementById('save-feedback-mod4');
            const saveButton = document.getElementById('save-button-mod4');

            // 1. Coletar o dado do formulário
            const respostaAbstracao = document.getElementById('p6_abstracao_projeto').value.trim();
            
            // 2. Criar o Array de Respostas
            const newAnswers = [
                {
                    id: "mod4_p6_abstracao_projeto",
                    ordem: 6, // Continua a contagem de ordem (Pergunta 6 do Projeto)
                    secao: "Modelo Essencial (Módulo 4)",
                    pergunta: formMod4.querySelector('label[for="p6_abstracao_projeto"]').textContent,
                    resposta: respostaAbstracao
                }
            ];

            // 3. Validação
            if (!respostaAbstracao) {
                feedbackDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700 block';
                feedbackDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Por favor, preencha o campo da abstração antes de salvar.';
                return;
            }

            try {
                // Desabilitar o botão e mostrar feedback
                saveButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Salvando...';

                // **Chave:** Salvar no campo 'perguntasM4' usando merge: true
                await db.collection("projetos").doc(PROJECT_DOC_ID).set({
                    perguntasM4: newAnswers, // Novo campo para o Módulo 4
                    ultimaAtualizacaoM4: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                // Feedback de sucesso
                feedbackDiv.className = 'mt-4 p-3 rounded-lg bg-green-100 text-green-700 block';
                feedbackDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Abstração do Projeto salva com sucesso!';
            } catch (error) {
                console.error("Erro ao salvar no Firebase: ", error);
                feedbackDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700 block';
                feedbackDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> Erro ao salvar. Tente novamente. (${error.message})`;
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save mr-2"></i> Salvar Abstração';
            }
        }

        // ----------------------------------------------------
        // Lógica de Carregamento (Pré-preenchimento)
        // ----------------------------------------------------
        async function loadProjectAnswersMod4() {
            try {
                const doc = await db.collection("projetos").doc(PROJECT_DOC_ID).get();
                if (doc.exists) {
                    const data = doc.data();
                    const answersM4 = data.perguntasM4 || [];
                    
                    const abstracaoData = answersM4.find(item => item.id === 'mod4_p6_abstracao_projeto');
                    const inputElement = document.getElementById('p6_abstracao_projeto');

                    if (abstracaoData && inputElement) {
                        inputElement.value = abstracaoData.resposta;
                    }
                }
            } catch (error) {
                console.error("Erro ao carregar dados do projeto:", error);
            }
        }
        
        // Chamada para carregar os dados ao carregar a página
        // loadProjectAnswersMod4(); // Descomente quando o Firebase SDK estiver configurado
    </script>
{% endblock %}
