{% extends "conteudo-base.html" %}

{% block title %}Módulo 6: Projeto Final{% endblock %}

{% block content_title %}Módulo 6: Projeto Final - Aplicando o Pensamento Computacional{% endblock %}

{% block content %}
    <div class="content-section">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-video mr-3"></i> Vídeo Aula: Montando e Avaliando o Projeto
        </h2>
        <div class="video-container">
            <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <p class="text-gray-500 mt-4">Aprenda a juntar as quatro partes do Pensamento Computacional para resolver seu desafio.</p>
    </div>

    <div class="content-section border-4 border-primary-indigo bg-indigo-50">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-cogs mr-3"></i> Seu Plano de Projeto Integrado
        </h2>
        <p class="text-gray-700 mb-4 font-semibold">Revise o seu Projeto Final, construído passo a passo através dos pilares do Pensamento Computacional (PC):</p>
        
        <div class="space-y-4 text-sm" id="project-summary-container">
            <div class="p-3 border rounded-lg bg-white shadow-md">
                <strong class="text-primary-indigo block text-base mb-1">Módulo 1: Objetivo Geral do Projeto</strong>
                <p class="text-gray-700 italic whitespace-pre-wrap" id="display_objetivo_geral">Carregando...</p>
            </div>
            
            <div class="p-3 border rounded-lg bg-white shadow-md">
                <strong class="text-primary-indigo block text-base mb-1">Módulo 2: Decomposição (Subproblemas)</strong>
                <p class="text-gray-700 italic whitespace-pre-wrap" id="display_decomposicao">Carregando...</p>
            </div>
            
            <div class="p-3 border rounded-lg bg-white shadow-md">
                <strong class="text-primary-indigo block text-base mb-1">Módulo 3: Reconhecimento de Padrões (Similaridades)</strong>
                <p class="text-gray-700 italic whitespace-pre-wrap" id="display_reconhecimento_padroes">Carregando...</p>
            </div>
            
            <div class="p-3 border rounded-lg bg-white shadow-md">
                <strong class="text-primary-indigo block text-base mb-1">Módulo 4: Abstração (Foco no Essencial)</strong>
                <p class="mt-1 text-gray-700 italic whitespace-pre-wrap" id="display_abstracao">Carregando...</p>
            </div>
            
            <div class="p-3 border rounded-lg bg-white shadow-md">
                <strong class="text-primary-indigo block text-base mb-1">Módulo 5: Algoritmo (Passos Sequenciais da Solução)</strong>
                <p class="mt-1 text-gray-700 italic whitespace-pre-wrap" id="display_algoritmo">Carregando...</p>
            </div>
        </div>

        <p class="mt-6 text-gray-800 font-medium">Parabéns! Este é o seu Projeto Final. Ao clicar em 'Finalizar Curso', você declara que este projeto está completo. Uma cópia final será salva em seu perfil.</p>
        
        <div id="project-feedback" class="mt-4 text-sm font-medium text-gray-600 hidden"></div>
        <button id="btn-final-save" class="mt-4 bg-secondary-green hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
            <i class="fas fa-save mr-2"></i> Salvar Versão Final
        </button>
    </div>

    <div class="content-section">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-clipboard-check mr-3"></i> Revisão Final: Exercícios de Fixação
        </h2>
        <div class="space-y-6">
            
            <div id="q-mod6-1" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Revisão do Conceito</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">1. O Pensamento Computacional (PC) é melhor caracterizado como:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod6-1', this, 'true', '✅ Correto! O PC é um conjunto de habilidades de pensamento para a resolução de problemas complexos, aplicável em qualquer disciplina.')" data-correct="true">
                        A) Um conjunto de habilidades de pensamento para formular e resolver problemas de forma sistemática.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod6-1', this, 'false', '❌ Incorreto. O PC é uma forma de pensar, e não se limita a linguagens de programação. É um conceito mais amplo.')" data-correct="false">
                        B) A capacidade de programar em linguagens como Python e Java.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod6-1', this, 'false', '❌ Incorreto. O PC visa a resolução de problemas, mas o foco não é apenas em seguir instruções mecanicamente, e sim em estruturar o raciocínio.')" data-correct="false">
                        C) A habilidade de seguir, de forma mecanizada, instruções complexas.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>
            
            <div id="q-mod6-2" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">IADES - 2022 (Adaptada)</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">2. Quais são os quatro pilares fundamentais do Pensamento Computacional?</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod6-2', this, 'false', '❌ Incorreto. Pensamento Crítico é uma habilidade geral, não um dos 4 pilares específicos do PC.')" data-correct="false">
                        A) Pensamento Crítico, Abstração, Decomposição e Codificação.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod6-2', this, 'true', '✅ Correto! Decomposição, Reconhecimento de Padrões, Abstração e Algoritmos são os 4 pilares centrais.')" data-correct="true">
                        B) Decomposição, Reconhecimento de Padrões, Abstração e Algoritmos.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod6-2', this, 'false', '❌ Incorreto. Análise de Dados e Topologia não são os termos padrão para os 4 pilares.')" data-correct="false">
                        C) Análise de Dados, Abstração, Algoritmos e Topologia.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>

            <div id="q-mod6-3" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Revisão de Abstração</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">3. A etapa de Abstração, no desenvolvimento de um projeto, serve para:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod6-3', this, 'false', '❌ Incorreto. Esta é a função do Algoritmo.')" data-correct="false">
                        A) Determinar a sequência exata de passos a serem executados.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod6-3', this, 'false', '❌ Incorreto. Esta é a função da Decomposição.')" data-correct="false">
                        B) Quebrar o problema em partes menores e gerenciáveis.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod6-3', this, 'true', '✅ Correto! Abstração foca nos detalhes mais relevantes para a solução, ignorando o que é irrelevante.')" data-correct="true">
                        C) Identificar as características essenciais do problema, ignorando os detalhes irrelevantes para a solução.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>

            <div id="q-mod6-4" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Revisão de Decomposição</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">4. Qual é o principal benefício da Decomposição em um contexto pedagógico?</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod6-4', this, 'true', '✅ Correto! A Decomposição torna a tarefa complexa mais acessível e encoraja a resolução de problemas passo a passo.')" data-correct="true">
                        A) Tornar problemas grandes mais fáceis de entender e resolver, ao dividi-los em partes menores.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod6-4', this, 'false', '❌ Incorreto. Esta é a função do Reconhecimento de Padrões.')" data-correct="false">
                        B) Encontrar similaridades entre o problema atual e problemas já resolvidos.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod6-4', this, 'false', '❌ Incorreto. Embora importante, esta é uma consequência do Algoritmo e da Abstração, não a principal função da Decomposição.')" data-correct="false">
                        C) Criar uma única solução generalizável para todas as partes do problema.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>

            <div id="q-mod6-5" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Revisão de Padrões</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">5. Ao aplicar o Reconhecimento de Padrões, um aluno busca:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod6-5', this, 'true', '✅ Correto! Reconhecer padrões permite que soluções de problemas anteriores sejam adaptadas para o problema atual.')" data-correct="true">
                        A) Identificar similaridades, repetições e tendências nos subproblemas para desenvolver soluções eficientes.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod6-5', this, 'false', '❌ Incorreto. Esta é a etapa de Abstração.')" data-correct="false">
                        B) Remover todos os detalhes e focar apenas no conceito principal.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod6-5', this, 'false', '❌ Incorreto. Esta é a etapa de Algoritmo.')" data-correct="false">
                        C) Criar uma lista de instruções passo a passo para a solução.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>
            
        </div>
    </div>
{% endblock %}

{% block finish_button %}
    <div class="mt-8 text-center">
        <form id="form-finish-course" method="POST" action="{{ url_for('concluir_modulo', modulo_nome='projeto-final') }}">
            <button type="submit" class="btn-finish hover:shadow-lg">
                <i class="fas fa-trophy mr-2"></i> Finalizar Curso e Gerar Certificado!
            </button>
        </form>
    </div>
{% endblock %}

{% block scripts %}
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração e Inicialização do Firebase (Assegure que as variáveis globais sejam injetadas pelo backend Flask)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        let db, auth, userId;
        const PROJECT_COLLECTION = 'project_data';
        const DOCUMENT_ID = 'main_project'; // Documento único para o projeto final

        setLogLevel('Debug'); // Para depuração, pode ser removido em produção.

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            async function authenticate() {
                try {
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser?.uid || crypto.randomUUID();
                    console.log("Firebase autenticado com userId:", userId);
                    loadProjectData(); // Carrega os dados assim que autenticado
                } catch (error) {
                    console.error("Erro na autenticação Firebase:", error);
                }
            }
            
            authenticate();
        } else {
            console.error("Configuração do Firebase não encontrada.");
        }

        function getProjectDocRef(dbInstance, uid) {
            // Caminho: artifacts / [appId] / users / [userId] / project_data / main_project
            return doc(dbInstance, 'artifacts', appId, 'users', uid, PROJECT_COLLECTION, DOCUMENT_ID);
        }

        async function loadProjectData() {
            if (!db || !userId) {
                setTimeout(loadProjectData, 500);
                return;
            }

            try {
                const docRef = getProjectDocRef(db, userId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Mapeamento dos campos do Firestore para os IDs de exibição
                    const projectFields = {
                        // M1: Objetivo Geral (Problema Inicial)
                        'display_objetivo_geral': data.objetivo_geral || 'N/A: Resposta do Módulo 1 não encontrada.',
                        // M2: Decomposição
                        'display_decomposicao': data.decomposicao || 'N/A: Resposta do Módulo 2 não encontrada.',
                        // M3: Padrões
                        'display_reconhecimento_padroes': data.reconhecimento_padroes || 'N/A: Resposta do Módulo 3 não encontrada.',
                        // M4: Abstração
                        'display_abstracao': data.abstracao || 'N/A: Resposta do Módulo 4 não encontrada.',
                        // M5: Algoritmo
                        'display_algoritmo': data.algoritmo || 'N/A: Resposta do Módulo 5 não encontrada.'
                    };

                    // Atualiza o DOM com os dados
                    for (const [id, value] of Object.entries(projectFields)) {
                        const el = document.getElementById(id);
                        if (el) {
                            el.textContent = value;
                        }
                    }

                    console.log("Dados do Projeto Final carregados:", data);
                } else {
                    console.log("Nenhum dado de projeto encontrado para este usuário.");
                }
            } catch (error) {
                console.error("Erro ao carregar dados do projeto:", error);
            }
        }

        async function saveFinalProjectData() {
            if (!db || !userId) {
                alert("Erro: O sistema de salvamento não está ativo. Tente recarregar a página.");
                return;
            }
            const feedbackEl = document.getElementById('project-feedback');
            try {
                const docRef = getProjectDocRef(db, userId);
                
                // Salva o estado atual do projeto como 'Finalizado' com um timestamp final
                const dataToSave = {
                    status_projeto: 'Concluído',
                    timestamp_finalizacao: new Date().toISOString()
                };

                await setDoc(docRef, dataToSave, { merge: true }); 
                
                feedbackEl.textContent = "✅ Projeto Final salvo e status de conclusão atualizado! Você pode finalizar o curso.";
                feedbackEl.classList.remove('hidden', 'text-red-500');
                feedbackEl.classList.add('text-green-700', 'bg-green-100', 'p-2', 'rounded');
            } catch (error) {
                console.error("Erro ao salvar dados finais do projeto:", error);
                feedbackEl.textContent = "❌ Erro ao salvar o projeto final. Tente novamente.";
                feedbackEl.classList.remove('hidden', 'text-green-700');
                feedbackEl.classList.add('text-red-700', 'bg-red-100', 'p-2', 'rounded');
            }
        }
        
        // Listener para o botão de salvar a versão final
        document.getElementById('btn-final-save').addEventListener('click', saveFinalProjectData);

        // --------------------------------------------------
        // Lógica de Verificação do Quiz (Mantida)
        // --------------------------------------------------
        window.checkAnswer = function(questionId, selectedOption, isCorrect, feedbackMessage) {
            const questionDiv = document.getElementById(questionId);
            const feedbackEl = questionDiv.querySelector('.feedback-message');
            const options = questionDiv.querySelectorAll('.quiz-option');

            // Converte o parâmetro 'isCorrect' para booleano
            const correct = isCorrect === 'true';

            // Desabilita todas as opções
            options.forEach(opt => {
                opt.classList.add('disabled');
                opt.onclick = null; // Remove o evento de clique
            });

            // Aplica estilos e exibe feedback
            if (correct) {
                selectedOption.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                selectedOption.classList.add('correct', 'border-green-500', 'bg-green-100');
                feedbackEl.textContent = feedbackMessage;
                feedbackEl.classList.remove('hidden', 'text-red-700', 'bg-red-100');
                feedbackEl.classList.add('text-green-700', 'bg-green-100', 'p-2', 'rounded');
            } else {
                selectedOption.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                selectedOption.classList.add('incorrect', 'border-red-500', 'bg-red-100');
                
                // Encontra e destaca a resposta correta
                options.forEach(opt => {
                    if (opt.getAttribute('data-correct') === 'true') {
                        opt.classList.remove('bg-gray-100');
                        opt.classList.add('correct', 'border-green-500', 'bg-green-200');
                    }
                });
                
                feedbackEl.textContent = feedbackMessage;
                feedbackEl.classList.remove('hidden', 'text-green-700', 'bg-green-100');
                feedbackEl.classList.add('text-red-700', 'bg-red-100', 'p-2', 'rounded');
            }
        };
    </script>
{% endblock %}
