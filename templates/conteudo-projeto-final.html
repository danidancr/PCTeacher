{% extends "conteudo-base.html" %}

{% block title %}Módulo 5: Projeto Final{% endblock %}

{% block content_title %}Módulo 5: Projeto Final - Aplicando o PC{% endblock %}

{% block content %}
    <div class="content-section">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-video mr-3"></i> Vídeo Aula: Montando e Avaliando o Projeto
        </h2>
        <div class="video-container">
            <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <p class="text-gray-500 mt-4">Aprenda a juntar as quatro partes do Pensamento Computacional para resolver seu desafio.</p>
    </div>

    <div class="content-section border-4 border-primary-indigo bg-indigo-50">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-cogs mr-3"></i> Seu Plano de Projeto Integrado
        </h2>
        <p class="text-gray-700 mb-6 font-semibold">Revise seu plano completo de Pensamento Computacional. Clique em "Editar" para fazer alterações em qualquer módulo:</p>
        
        <div id="project-plan-container" class="space-y-4 text-sm">
            
            {% set modulos_projeto = [
                ('problema-inicial', 'Módulo 0 - Problema Inicial', 'problema-inicial', 'project_problem_input'),
                ('decomposicao', 'Módulo 1 - Decomposição', 'decomposicao', 'project_decomposition'),
                ('padroes', 'Módulo 2 - Reconhecimento de Padrões', 'padroes', 'project_pattern'),
                ('abstracao', 'Módulo 3 - Abstração', 'abstracao', 'project_abstraction'),
                ('algoritmo', 'Módulo 4 - Algoritmo (Solução)', 'algoritmo', 'project_algorithm')
            ] %}

            {% for slug, titulo, url_slug, json_key in modulos_projeto %}
            <div class="p-3 border rounded-lg bg-white flex justify-between items-start" id="proj-card-{{ slug }}">
                <div>
                    <strong class="text-primary-indigo">{{ titulo }}:</strong> 
                    <p class="mt-1 text-gray-700 whitespace-pre-wrap" data-json-key="{{ json_key }}" id="proj-mod-{{ slug }}">
                        [Carregando...]
                    </p>
                </div>
                <div class="ml-4 flex-shrink-0">
                    <a href="{{ url_for('visualizar_modulo', modulo_slug=url_slug) }}" class="text-sm text-primary-indigo hover:text-indigo-700 font-medium border border-primary-indigo px-3 py-1 rounded transition duration-150">
                        <i class="fas fa-edit mr-1"></i> Editar
                    </a>
                </div>
            </div>
            {% endfor %}

        </div>

        <p class="mt-8 text-gray-800">Seu plano está completo. Agora você pode finalizar o curso ou baixar seu projeto para uso futuro.</p>
        
        <div class="mt-6 flex justify-start space-x-4">
            <button onclick="downloadProjectPlan()" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center shadow-md">
                <i class="fas fa-download mr-2"></i> Baixar Projeto (PDF/TXT)
            </button>
        </div>
    </div>
    
{% endblock %}

{% block finish_button %}
    <div class="mt-8 text-center">
        <form method="POST" action="{{ url_for('concluir_modulo', modulo_nome='projeto-final') }}">
            <button type="submit" class="btn-finish hover:shadow-lg">
                <i class="fas fa-trophy mr-2"></i> Finalizar Curso e Gerar Certificado!
            </button>
        </form>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    
    <script>
        // Função para parsear o JSON salvo e extrair o valor do campo específico
        function extractProjectData(rawResponse, jsonKey) {
            if (!rawResponse) return "[Nenhuma resposta salva neste módulo]";
            
            // Caso especial para o Módulo 0 (Problema Inicial) que é salvo como string simples
            if (jsonKey === 'project_problem_input') {
                return rawResponse.replace(/\\n/g, '\n'); // Formatação básica de quebra de linha
            }

            try {
                // Tenta fazer o parse do JSON
                const data = JSON.parse(rawResponse);
                // Extrai a chave específica (ex: project_decomposition)
                const value = data[jsonKey] || rawResponse; 
                return value.replace(/\\n/g, '\n'); // Formatação básica de quebra de linha
            } catch (e) {
                // Se o parse falhar (ex: string simples), retorna a string bruta
                return rawResponse.replace(/\\n/g, '\n');
            }
        }

        // Variável de contexto passada pelo Flask
        const projectResponses = {{ respostas_projeto | tojson }};

        // Função para carregar as respostas no HTML
        function loadAllResponses() {
            const moduleSlugs = ['problema-inicial', 'decomposicao', 'padroes', 'abstracao', 'algoritmo'];

            moduleSlugs.forEach(slug => {
                const element = document.getElementById(`proj-mod-${slug}`);
                if (element) {
                    const rawResponse = projectResponses[slug];
                    const jsonKey = element.getAttribute('data-json-key');
                    
                    element.textContent = extractProjectData(rawResponse, jsonKey);
                }
            });
        }

        // Função para baixar o plano completo
        function downloadProjectPlan() {
            let content = "===== Meu Projeto Final de Pensamento Computacional =====\n\n";
            
            // Mapeia os cards e seus respectivos títulos e chaves de JSON
            const modules = [
                { slug: 'problema-inicial', title: 'Módulo 0 - Problema Inicial', jsonKey: 'project_problem_input' },
                { slug: 'decomposicao', title: 'Módulo 1 - Decomposição', jsonKey: 'project_decomposition' },
                { slug: 'padroes', title: 'Módulo 2 - Reconhecimento de Padrões', jsonKey: 'project_pattern' },
                { slug: 'abstracao', title: 'Módulo 3 - Abstração', jsonKey: 'project_abstraction' },
                { slug: 'algoritmo', title: 'Módulo 4 - Algoritmo (Solução)', jsonKey: 'project_algorithm' }
            ];

            modules.forEach(mod => {
                const rawResponse = projectResponses[mod.slug];
                const responseText = extractProjectData(rawResponse, mod.jsonKey);

                content += `\n--- ${mod.title} ---\n`;
                content += responseText + "\n";
            });
            
            content += "\n=======================================================\n";
            
            // Cria um Blob e um link para download (Arquivo .txt)
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Projeto_PC_Integrado.txt';
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Inicia o carregamento das respostas quando a página estiver pronta
        document.addEventListener('DOMContentLoaded', loadAllResponses);
    </script>
{% endblock %}
