{% extends "conteudo-base.html" %}

{% block title %}Módulo 2: Decomposição{% endblock %}

{% block content_title %}Módulo 2: A Arte da Decomposição{% endblock %}

{% block content %}
    <div class="content-section">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-video mr-3"></i> Vídeo Aula: Quebrando o Problema em Partes
        </h2>
        <div class="video-container">
            <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <p class="text-gray-500 mt-4">Aprenda a simplificar qualquer desafio dividindo-o em subtarefas gerenciáveis.</p>
    </div>
    
    <div class="content-section">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-clipboard-check mr-3"></i> Exercícios de Fixação
        </h2>
        <div class="space-y-6">
            
            <div id="q-mod1-1" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Conceitual</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">1. A decomposição é válida no âmbito educacional porque permite:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-1', this, 'false', '❌ Incorreto. A decomposição mantém as relações entre as partes para que a solução final seja coerente.')" data-correct="false">
                        A) Tratar partes de um problema isoladamente, sem relação entre si.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-1', this, 'true', '✅ Excelente! Decompor é compreender a estrutura de um sistema complexo a partir da análise das suas partes interconectadas, tornando o problema gerenciável.')" data-correct="true">
                        B) Entender o todo a partir da análise de suas partes interconectadas.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-1', this, 'false', '❌ Incorreto. O objetivo é simplificar, mas mantendo todas as etapas críticas.')" data-correct="false">
                        C) Reduzir a complexidade eliminando etapas críticas.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-1', this, 'false', '❌ Incorreto. A decomposição é, fundamentalmente, uma ferramenta de planejamento.')" data-correct="false">
                        D) Resolver problemas sem planejamento prévio.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-1', this, 'false', '❌ Incorreto. O PC exige reflexão constante sobre o processo.')" data-correct="false">
                        E) Repetir processos automáticos sem reflexão.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>

            <div id="q-mod1-2" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Aplicação Pedagógica</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">2. Em contextos educacionais, decompor um problema significa:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-2', this, 'false', '❌ Incorreto. A decomposição é o oposto da memorização, pois foca na compreensão estrutural do conteúdo.')" data-correct="false">
                        A) Reduzir o conteúdo a tópicos de memorização.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-2', this, 'true', '✅ Correto! Decomposição, no ensino, transforma grandes objetivos em pequenas etapas de aprendizagem sequenciais e interligadas.')" data-correct="true">
                        B) Planejar etapas didáticas coerentes e complementares.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-2', this, 'false', '❌ Incorreto. O foco é na conexão, e não na fragmentação do conhecimento.')" data-correct="false">
                        C) Fragmentar o conhecimento sem conexão.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-2', this, 'false', '❌ Incorreto. A decomposição é uma habilidade de raciocínio, não um método de cálculo.')" data-correct="false">
                        D) Aplicar fórmulas matemáticas a problemas sociais.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-2', this, 'false', '❌ Incorreto. A decomposição exige que se foque tanto no processo quanto no produto final.')" data-correct="false">
                        E) Focar apenas no produto final.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>

            <div id="q-mod1-3" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Desafios</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">3. Um desafio da decomposição é:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-3', this, 'false', '❌ Incorreto. A decomposição deve ser revisada e ajustada conforme o andamento do processo.')" data-correct="false">
                        A) Não permitir revisão dos subproblemas.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-3', this, 'true', '✅ Perfeito! O maior desafio é garantir que as relações entre as partes funcionem corretamente para alcançar o objetivo geral.')" data-correct="true">
                        B) Requerer análise constante das relações entre partes.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-3', this, 'false', '❌ Incorreto. Pelo contrário, ela facilita o trabalho colaborativo ao atribuir subtarefas.')" data-correct="false">
                        C) Impedir o trabalho colaborativo.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-3', this, 'false', '❌ Incorreto. A decomposição busca entender as interdependências para garantir a solução final.')" data-correct="false">
                        D) Eliminar as interdependências.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-3', this, 'false', '❌ Incorreto. É aplicável a todos os contextos da vida e do ensino.')" data-correct="false">
                        E) Ser aplicável apenas em contextos tecnológicos.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>

            <div id="q-mod1-4" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Falha na Aplicação</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">4. Quando a decomposição falha, o problema costuma estar em:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-4', this, 'false', '❌ Incorreto. O trabalho em equipe costuma ser positivo para a decomposição.')" data-correct="false">
                        A) Excesso de colaboração.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-4', this, 'true', '✅ Exato! A falta de clareza nas partes (subproblemas) impede que o processo de montagem final funcione.')" data-correct="true">
                        B) Falta de clareza na definição dos subproblemas.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-4', this, 'false', '❌ Incorreto. A divisão é necessária; o problema é a fragmentação sem propósito.')" data-correct="false">
                        C) Divisão excessiva do conteúdo.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-4', this, 'false', '❌ Incorreto. Revisões são benéficas.')" data-correct="false">
                        D) Número elevado de revisões.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-4', this, 'false', '❌ Incorreto. A decomposição é um processo mental, não dependente de tecnologia.')" data-correct="false">
                        E) Falta de recursos tecnológicos.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>

            <div id="q-mod1-5" class="border p-4 rounded-lg bg-white shadow">
                <p class="font-semibold text-sm mb-2 text-gray-500">Metodologia</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">5. Em um planejamento didático, a decomposição pode auxiliar na:</p>
                <div class="space-y-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-5', this, 'false', '❌ Incorreto. O termo "fragmentação" sugere divisão sem sentido; a decomposição busca conexões.')" data-correct="false">
                        A) Fragmentação do conhecimento.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-5', this, 'true', '✅ Exato! A decomposição é a base para criar um fluxo de ensino progressivo e interligado, ou seja, sequências didáticas coerentes.')" data-correct="true">
                        B) Organização de sequências didáticas coerentes.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-5', this, 'false', '❌ Incorreto. A decomposição foca em como resolver o problema, e não em eliminar etapas.')" data-correct="false">
                        C) Eliminação de conteúdos secundários.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-5', this, 'false', '❌ Incorreto. As etapas avaliativas são subproblemas importantes que precisam ser decompostos.')" data-correct="false">
                        D) Exclusão de etapas avaliativas.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="checkAnswer('q-mod1-5', this, 'false', '❌ Incorreto. O objetivo é dar ao aluno autonomia sobre as partes do processo.')" data-correct="false">
                        E) Redução da autonomia discente.
                    </div>
                </div>
                <div class="feedback-message mt-4 hidden"></div>
            </div>

        </div>
    </div>

    <div class="content-section border-4 border-indigo-200 bg-indigo-50 p-6 rounded-xl">
        <h2 class="text-2xl font-bold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-bullhorn mr-3"></i> Questão de Projeto: Justificativa
        </h2>
        <p class="text-gray-700 mb-6">Com base no conceito de **Decomposição de Problemas**, explique a relevância e a necessidade do seu projeto (definido no Módulo 1).</p>
        
        <form id="project-questions-form-mod2" onsubmit="saveProjectAnswersMod2(event)">
            
            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2 border-indigo-300">Justificativa do Projeto (Módulo 2)</h3>

            <div class="mb-6">
                <label for="p4_justificativa" class="block text-gray-800 font-medium mb-2">1. Descreva a relevância do seu projeto, respondendo: Qual problema ele resolve e por que ele é importante para o seu público-alvo?</label>
                <textarea id="p4_justificativa" rows="6" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-primary-indigo focus:border-primary-indigo" placeholder="Ex: O projeto é crucial para preencher a lacuna na alfabetização digital, preparando os alunos para o mercado futuro." required></textarea>
            </div>
            
            <button type="submit" id="save-button-mod2" class="mt-4 bg-primary-indigo hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                <i class="fas fa-save mr-2"></i> Salvar Justificativa
            </button>

            <div id="save-feedback-mod2" class="mt-4 p-3 rounded-lg text-sm hidden" role="alert"></div>

        </form>
    </div>
{% endblock %}

{% block finish_button %}
    <div class="mt-8 text-center">
        <form method="POST" action="{{ url_for('concluir_modulo', modulo_nome='decomposicao') }}">
            <button type="submit" class="btn-finish hover:shadow-lg">
                <i class="fas fa-check-double mr-2"></i>Próximo Módulo
            </button>
        </form>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        // Assumindo que o Firebase SDK e sua inicialização já estão carregados (db)
        // const db = firebase.firestore(); 
        
        // **IMPORTANTE**: Garanta que o UID do usuário seja a mesma variável usada no Módulo 1.
        const CURRENT_USER_ID = '{{ g.user.uid if g.user else "teste-user-id" }}'; 
        const PROJECT_DOC_ID = 'user_project_' + CURRENT_USER_ID; 
        const formMod2 = document.getElementById('project-questions-form-mod2');

        // ----------------------------------------------------
        // Lógica de Salvamento Módulo 2 (Firebase/Firestore)
        // ----------------------------------------------------
        async function saveProjectAnswersMod2(event) {
            event.preventDefault(); 
            
            const feedbackDiv = document.getElementById('save-feedback-mod2');
            const saveButton = document.getElementById('save-button-mod2');

            // 1. Coletar o dado do formulário
            const respostaJustificativa = document.getElementById('p4_justificativa').value.trim();
            
            // 2. Criar o Array de Respostas
            const newAnswers = [
                {
                    id: "mod2_p4_justificativa",
                    ordem: 4, // Continua a contagem de ordem (Pergunta 4 do Projeto)
                    secao: "Justificativa (Módulo 2)",
                    pergunta: formMod2.querySelector('label[for="p4_justificativa"]').textContent,
                    resposta: respostaJustificativa
                }
            ];

            // 3. Validação
            if (!respostaJustificativa) {
                feedbackDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700 block';
                feedbackDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Por favor, preencha o campo de justificativa antes de salvar.';
                return;
            }

            try {
                // Desabilitar o botão e mostrar feedback
                saveButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Salvando...';

                // **Chave:** Salvar no campo 'perguntasM2' usando merge: true
                await db.collection("projetos").doc(PROJECT_DOC_ID).set({
                    perguntasM2: newAnswers, // Novo campo para o Módulo 2
                    ultimaAtualizacaoM2: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                // Feedback de sucesso
                feedbackDiv.className = 'mt-4 p-3 rounded-lg bg-green-100 text-green-700 block';
                feedbackDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Justificativa do projeto salva com sucesso!';
            } catch (error) {
                console.error("Erro ao salvar no Firebase: ", error);
                feedbackDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700 block';
                feedbackDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> Erro ao salvar. Tente novamente. (${error.message})`;
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save mr-2"></i> Salvar Justificativa';
            }
        }

        // ----------------------------------------------------
        // Lógica de Carregamento (Pré-preenchimento)
        // ----------------------------------------------------
        async function loadProjectAnswersMod2() {
            try {
                const doc = await db.collection("projetos").doc(PROJECT_DOC_ID).get();
                if (doc.exists) {
                    const data = doc.data();
                    const answersM2 = data.perguntasM2 || [];
                    
                    const justificativaData = answersM2.find(item => item.id === 'mod2_p4_justificativa');
                    const inputElement = document.getElementById('p4_justificativa');

                    if (justificativaData && inputElement) {
                        inputElement.value = justificativaData.resposta;
                    }
                }
            } catch (error) {
                console.error("Erro ao carregar dados do projeto:", error);
            }
        }
        
        // Chamada para carregar os dados ao carregar a página
        // loadProjectAnswersMod2(); // Descomente quando o Firebase SDK estiver configurado
    </script>
{% endblock %}
